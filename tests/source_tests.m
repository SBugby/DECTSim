classdef source_tests < matlab.unittest.TestCase

    methods(Test)
        function test_single_energy(tc)
            s1 = single_energy(50);
            tc.verifyEqual(s1.energy, 50);
            [e_min, e_max] = s1.get_energy_range();
            tc.verifyEqual(e_min, 49);
            tc.verifyEqual(e_max, 51);

            range1 = [0 10; 10 20; 20 30; 30 40; 40 50; 50 60];
            expE = [50; 50; 50; 50; 50; 50]';
            expI = [0; 0; 0; 0; 0; 1e6]';
            e = s1.get_energies(range1);
            i = s1.get_fluences(range1, 1);
            tc.verifyEqual(e, expE);
            tc.verifyEqual(i, expI);

            i = s1.get_fluences(range1, 1:10);
            tc.verifyEqual(i, repmat(expI, 10, 1));

            s2 = single_energy(21);
            tc.verifyEqual(s2.energy, 21);
            [e_min, e_max] = s2.get_energy_range();
            tc.verifyEqual(e_min, 20);
            tc.verifyEqual(e_max, 22);

            range2 = [0 7; 7 10; 10 15; 15 25; 25 30; 30 40; 40 50; 50 60];
            expE = [21; 21; 21; 21; 21; 21; 21; 21]';
            expI = [0; 0; 0; 1e6; 0; 0; 0; 0]';
            e = s2.get_energies(range2);
            i = s2.get_fluences(range2, 1);
            tc.verifyEqual(e, expE);
            tc.verifyEqual(i, expI);
            
            i = s2.get_fluences(range2, 1:10);
            tc.verifyEqual(i, repmat(expI, 10, 1));
        end

        function test_fromfile(tc)
            data = [1.5000,0.0000; 2.5000,0.0000; 3.5000,0.0000; 4.5000,0.0000;
                    5.5000,0.0000; 6.5000,0.0000; 7.5000,0.0000; 8.5000,0.0000;
                    9.5000,0.0000; 10.5000,0.0003; 11.5000,0.1463; 12.5000,3.6004
                    13.5000,71.8812; 14.5000,702.0055; 15.5000,3974.2311; 16.5000,15194.3524
                    17.5000,43579.7339; 18.5000,99823.3636; 19.5000,194318.4095; 
                    20.5000,332122.6241; 21.5000,512861.8586; 22.5000,730201.4979;
                    23.5000,974568.4995; 24.5000,1238234.9687; 25.5000,1507282.8827;
                    26.5000,1771667.9576; 27.5000,2025445.0004; 28.5000,2252511.2145;
                    29.5000,2460296.8810; 30.5000,2639399.5744; 31.5000,2789290.0714;
                    32.5000,2916771.5669; 33.5000,3022230.1166; 34.5000,3106498.0017;
                    35.5000,3163142.2757; 36.5000,3195074.2243; 37.5000,3211914.5414;
                    38.5000,3214979.8933; 39.5000,3205694.0615; 40.5000,3180300.2508;
                    41.5000,3141114.2826; 42.5000,3094702.4266; 43.5000,3041959.8999;
                    44.5000,2983738.1968; 45.5000,2917590.0357; 46.5000,2844759.8856;
                    47.5000,2769308.4106; 48.5000,2691732.6485; 49.5000,2612535.8109;
                    50.5000,2529869.2686; 51.5000,2444527.2889; 52.5000,2358918.6159;
                    53.5000,2273359.1836; 54.5000,2187656.3305; 55.5000,2100706.6321;
                    56.5000,2013237.7268; 57.5000,2529199.5336; 58.5000,1840185.5173;
                    59.5000,2834916.0573; 60.5000,1668625.5746; 61.5000,1583013.0875;
                    62.5000,1497989.5116; 63.5000,1413508.6616; 64.5000,1329557.2607;
                    65.5000,1245632.2088; 66.5000,1293180.7143; 67.5000,1340480.1885;
                    68.5000,995252.9246; 69.5000,995109.3613; 70.5000,786882.7618;
                    71.5000,710400.7260; 72.5000,633303.9447; 73.5000,555465.0211;
                    74.5000,476481.1458; 75.5000,396112.0471; 76.5000,314269.5785;
                    77.5000,230691.5663; 78.5000,145363.1041; 79.5000,56373.3614];
            ebins = data(:,1);
            fluences = data(:,2) .* 100^2*units.cm2;
            s = source_fromfile('test.spk');
            tc.verifyEqual(s.ebins, ebins);
            tc.verifyEqual(s.fluences, fluences .* ebins, 'RelTol', 3e-16);

            range = [1 2; 13 14; 25 26; 37 38];
            expE = [1.5, 13.5, 25.5, 37.5];
            expI = [
                0;
                71.8812 *  13.5; 
                1507282.8827 * 25.5;
                3211914.5414 * 37.5
            ]'.*100^2*units.cm2;
            e = s.get_energies(range);
            i = s.get_fluences(range, 1);
            tc.verifyEqual(e, expE);
            % Precision is lost when summing large numbers
            tc.verifyEqual(i, expI, 'RelTol', 1e-10);
            i = s.get_fluences(range, 1:10);
            tc.verifyEqual(i, repmat(expI, 10, 1), 'RelTol', 1e-10);

            range = [0 10; 40 50; 70 80];
            
            expI = [
                0; 
                3180300.2508 * 40.5 + 3141114.2826 * 41.5 + 3094702.4266 * 42.5 + ...
                3041959.8999 * 43.5 + 2983738.1968 * 44.5 + 2917590.0357 * 45.5 + ...
                2844759.8856 * 46.5 + 2769308.4106 * 47.5 + 2691732.6485 * 48.5 + ...
                2612535.8109 * 49.5;
                786882.7618 * 70.5 + 710400.7260 * 71.5 + 633303.9447 * 72.5 + ...
                555465.0211 * 73.5 + 476481.1458 * 74.5 + 396112.0471 * 75.5 + ...
                314269.5785 * 76.5 + 230691.5663 * 77.5 + 145363.1041 * 78.5 + ...
                56373.3614  * 79.5 
            ]'.*100^2*units.cm2;
            expE = [
                5.5;
                (...
                    3180300.2508 * 40.5^2 + 3141114.2826 * 41.5^2 + 3094702.4266 * 42.5^2 + ...
                    3041959.8999 * 43.5^2 + 2983738.1968 * 44.5^2 + 2917590.0357 * 45.5^2 + ...
                    2844759.8856 * 46.5^2 + 2769308.4106 * 47.5^2 + 2691732.6485 * 48.5^2 + ...
                    2612535.8109 * 49.5^2)/(...
                    3180300.2508 * 40.5 + 3141114.2826 * 41.5 + 3094702.4266 * 42.5 + ...
                    3041959.8999 * 43.5 + 2983738.1968 * 44.5 + 2917590.0357 * 45.5 + ...
                    2844759.8856 * 46.5 + 2769308.4106 * 47.5 + 2691732.6485 * 48.5 + ...
                    2612535.8109 * 49.5);
                (...
                    786882.7618 * 70.5^2 + 710400.7260 * 71.5^2 + 633303.9447 * 72.5^2 + ...
                    555465.0211 * 73.5^2 + 476481.1458 * 74.5^2 + 396112.0471 * 75.5^2 + ...
                    314269.5785 * 76.5^2 + 230691.5663 * 77.5^2 + 145363.1041 * 78.5^2 + ...
                    56373.3614  * 79.5^2)/(...
                    786882.7618 * 70.5 + 710400.7260 * 71.5 + 633303.9447 * 72.5 + ...
                    555465.0211 * 73.5 + 476481.1458 * 74.5 + 396112.0471 * 75.5 + ...
                    314269.5785 * 76.5 + 230691.5663 * 77.5 + 145363.1041 * 78.5 + ...
                    56373.3614  * 79.5)

            ]';
            e = s.get_energies(range);
            i = s.get_fluences(range, 1);
            tc.verifyEqual(e, expE, 'RelTol', 1e-13);
            % Precision is lost when summing large numbers
            tc.verifyEqual(i, expI, 'RelTol', 1e-13); 
            i = s.get_fluences(range, 1:10);
            tc.verifyEqual(i, repmat(expI, 10, 1), 'RelTol', 1e-13);

            [e_min, e_max] = s.get_energy_range();
            tc.verifyEqual(e_min, ebins(1));
            tc.verifyEqual(e_max, ebins(end));
        end
    end
end